'use strict';

let basicAuthHeaderParser = require('basic-auth');
let cookie = require('cookie');
let cookieUtils = require('../utils/cookie-utils');
let oauthConfig = require('./../passport/oauth-configuration');
let passport = require('passport');
let headerUtil = require('../utils/header-util');
let pathUtil = require('../utils/path-util');
let sessionExt = require('../utils/session-ext');
let tokenUtils = require('../utils/token-utils');
let jwtDecode = require('jwt-decode');
let expiresAt = require('../passport/utils').getExpiresAt;

module.exports = {
  isLoginRequired: function (req) {
    let isPublicPath = pathUtil.isPublicPath(req);
    let isUserLoggedIn = module.exports.isUserLoggedIn(req);
    return !isPublicPath && !isUserLoggedIn;
  },

  isUserLoggedIn: function (req) {
    let user = req.session && req.session.user;
    if (!user || !user.token.accessToken || !user.token.expiryDate) {
      return false;
    }
    return user.token.expiryDate > Date.now();
  },

  isExchangeTokenRequired: function(req){
    let user = req.session && req.session.user;
    let serviceName = req.destinationCredentials && req.destinationCredentials.serviceName;
    if (!user || !user.token || !serviceName){
      return false;
    }
    return !user.businessServices || !user.businessServices[serviceName] || user.businessServices[serviceName].expireDate < Date.now();
  },

  exchangeToken: function(req, cb){
    let loginToken  = req.session.user.token.accessToken;

    if (req.destinationCredentials.ias){
      tokenUtils.exchangeToken(loginToken,req.destinationCredentials.ias, (err, iasExchangedToken) => {
        if (err){
          return cb(err);
        }
        if (req.destinationCredentials.uaa){
          tokenUtils.exchangeToken(loginToken, req.destinationCredentials.uaa, (err, xsuaaExchangedToken) => {
            if (err) {
              return cb(err);
            }
            updateSession(req, iasExchangedToken, xsuaaExchangedToken);
            return cb(null);
          });
        } else {
          updateSession(req, iasExchangedToken, null);
          return cb(null);
        }
      });
    } else {
      tokenUtils.exchangeToken(loginToken, req.destinationCredentials.uaa, (err, xsuaaExchangedToken) => {
        if (err) {
          return cb(err);
        }
        updateSession(req, null, xsuaaExchangedToken);
        return cb(null);
      });
    }
  },

  getAuthenticator: function (req, res, cb) {
    if (pathUtil.isBasicAuthProtectedPath(req)) {
      return getBasicAuthAuthenticator(req, cb);
    }

    getXSUAAOauthAuthenticator(req, function(err, authenticator) {
      if (err) { return cb(err); }

      if (process.env.PRESERVE_FRAGMENT === 'false') {
        let redirectCookieName = cookieUtils.getRedirectLocationCookieName();
        let cookies = (req.headers.cookie && cookie.parse(req.headers.cookie)) || {};
        let redirectCookie = cookies[redirectCookieName];
        if (!redirectCookie) {
          let locationAfterLogin = cookie.serialize(redirectCookieName, req.url, {path: '/', httpOnly: true});
          cookieUtils.setCookie(res, locationAfterLogin);
        }
      }
      res.setHeader('Cache-Control', headerUtil.NOCACHE_HEADER_VALUE);
      cb(null, authenticator);
    });
  }
};

function getXSUAAOauthAuthenticator(req, cb) {
  oauthConfig.getXSUAAOauthStrategy(req, function(err, oauthStrategy) {
    if (err) { return cb(err);}
    cb(null, createAuthenticator(oauthStrategy));
  });
}

function getBasicAuthAuthenticator(req, cb) {
  let basicAuthHeader = basicAuthHeaderParser(req);
  if (!basicAuthHeader) {
    return cb(401);
  }

  let credentials = {
    username: basicAuthHeader.name,
    password: basicAuthHeader.pass
  };

  oauthConfig.getBasicOauthStrategy(req, credentials, function(err, oauthStrategy) {
    if (err) { return cb(err);}
    cb(null, createAuthenticator(oauthStrategy));
  });
}

function createAuthenticator(oauthStrategy) {
  passport.use(oauthStrategy);
  return passport.authenticate(oauthStrategy.name);
}

function updateSession(req,iasExchangedToken,xsuaaExchangedToken){
  let exchangedTokenDecoded = iasExchangedToken ? jwtDecode(iasExchangedToken) : jwtDecode(xsuaaExchangedToken);
  let expireDate = expiresAt(exchangedTokenDecoded.exp - exchangedTokenDecoded.iat).getTime();
  let accessToken = iasExchangedToken ? iasExchangedToken : xsuaaExchangedToken;

  sessionExt.update(req.session, function(session) {
    if (!session.user.businessServices){
      session.user.businessServices = {};
    }
    session.user.businessServices[req.destinationCredentials.serviceName] = {
      accessToken: accessToken,
      expireDate:  expireDate,
      scopes: exchangedTokenDecoded ? exchangedTokenDecoded.granted_scopes || exchangedTokenDecoded.scope : null
    };
  });
}