'use strict';

var _ = require('lodash');
var path = require('path');
var xsenv = require('@sap/xsenv');
var VError = require('verror').VError;
var tracer = require('../utils/logger').getTracer(__filename);

exports.load = function (workingDir) {
  var pathToDefaultServices = path.join(workingDir, 'default-services.json');
  try {
    let iasCredentials = xsenv.getServices({ ias: matchesIas }, pathToDefaultServices).ias;
    if (process.env.IAS_PRIVATE_KEY){
      iasCredentials.key = process.env.IAS_PRIVATE_KEY;
    }
    return iasCredentials;
  } catch (e) {
    tracer.debug(new VError(e, 'Cannot find service ias in environment'));
    return {};
  }
};

function matchesIas(service) {
  var iasName = process.env.IAS_SERVICE_NAME;
  if (iasName) {
    return service.name === iasName;
  }

  if (_.includes(service.label, 'identity') || service.label === 'identity') {
    return true;
  }
  if (service.label === 'user-provided' && service.credentials && (_.includes(service.credentials.label, 'identity') || service.label === 'identity')) {
    return true;
  }
  return false;
}
