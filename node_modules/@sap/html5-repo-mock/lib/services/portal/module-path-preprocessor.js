const console = require('../../utils/logger.js');

const INJECT_BEFORE = 'jQuery.sap.registerModulePath';

const registerModulePaths = (metadata) => {
    return metadata.map(
        app => 'jQuery.sap.registerModulePath('+
            `"${app.applicationId}",`+
            `"/${app.applicationName}-${app.applicationVersion}"`+
            ');\n        '
    ).join('');
};

module.exports = (metadata) => function modulePathPreprocessor(data, res) {
    const index = data.indexOf(INJECT_BEFORE);
    if (index >= 0) {
        const code = registerModulePaths(metadata);
        console.debug('Registering module paths:\n' + code);
        return res.end(data.slice(0, index) + code + data.slice(index));
    } else {
        console.error('Can\'t inject module path registration. The string "' + INJECT_BEFORE + '" not found');
        return res.end(data);
    }
};
